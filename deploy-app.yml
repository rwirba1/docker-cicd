---
- hosts: all
  become: true
  vars:
    ansible_user: ubuntu
  tasks:
    - name: Ensure Docker is installed
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Add user to docker group (if necessary)
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Copy code to EC2 instance
      copy:
        src: /home/ubuntu/workspace/app-build  # Source directory (from Jenkins slave)
        dest: /home/{{ ansible_user }}/app
        owner: ubuntu
        group: ubuntu
        mode: 0755        

    - name: Build Docker image on the EC2 Docker server
      command: docker build -t my-app-image:latest . chdir=/home/{{ ansible_user }}/app

    - name: Stop any existing Docker container
      shell: |
        docker stop my-app-container || true
        docker rm my-app-container || true

    - name: Run the Docker container on port 8081
      docker_container:
        name: my-app-container
        image: my-app-image:latest
        state: started
        ports:
          - "8081:8081"
